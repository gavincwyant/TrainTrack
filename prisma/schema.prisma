// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

// ============================================================================
// Core Models
// ============================================================================

model Workspace {
  id        String  @id @default(uuid())
  name      String
  subdomain String? @unique
  trainerId String  @map("trainer_id")
  trainer   User    @relation("TrainerWorkspace", fields: [trainerId], references: [id], onDelete: Cascade)

  subscriptionTier String? @map("subscription_tier")

  users                   User[]                   @relation("WorkspaceMembers")
  clientProfiles          ClientProfile[]
  clientTrainers          ClientTrainer[]
  appointments            Appointment[]
  workoutSessions         WorkoutSession[]
  invoices                Invoice[]
  availabilityBlocks      AvailabilityBlock[]
  blockedTimes            BlockedTime[]
  trainerSettings         TrainerSettings[]
  customMetricDefinitions CustomMetricDefinition[]
  calendarEventMappings   CalendarEventMapping[]
  pendingAppointments     PendingAppointment[]
  pendingClientProfiles   PendingClientProfile[]
  notificationLogs        NotificationLog[]

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("workspaces")
}

model User {
  id           String     @id @default(uuid())
  email        String     @unique
  passwordHash String     @map("password_hash")
  role         Role
  workspaceId  String?    @map("workspace_id")
  workspace    Workspace? @relation("WorkspaceMembers", fields: [workspaceId], references: [id], onDelete: Cascade)

  fullName      String  @map("full_name")
  phone         String?
  profileImage  String? @map("profile_image")
  isSystemAdmin Boolean @default(false) @map("is_system_admin")

  ownedWorkspaces              Workspace[]            @relation("TrainerWorkspace")
  clientProfile                ClientProfile?
  trainerAppointments          Appointment[]          @relation("TrainerAppointments")
  clientAppointments           Appointment[]          @relation("ClientAppointments")
  trainerWorkoutSessions       WorkoutSession[]       @relation("TrainerSessions")
  clientWorkoutSessions        WorkoutSession[]       @relation("ClientSessions")
  trainerInvoices              Invoice[]              @relation("TrainerInvoices")
  clientInvoices               Invoice[]              @relation("ClientInvoices")
  availabilityBlocks           AvailabilityBlock[]
  blockedTimes                 BlockedTime[]          @relation("TrainerBlockedTimes")
  trainerSettings              TrainerSettings?       @relation("TrainerSettings")
  trainerPendingAppointments   PendingAppointment[]   @relation("TrainerPendingAppointments")
  clientPendingAppointments    PendingAppointment[]   @relation("ClientPendingAppointments")
  trainerPendingClientProfiles PendingClientProfile[] @relation("TrainerPendingClientProfiles")
  convertedFromPendingClient   PendingClientProfile?  @relation("ConvertedFromPendingClient")

  // Client-Trainer relationships
  clientTrainers ClientTrainer[] @relation("ClientTrainers")
  trainerClients ClientTrainer[] @relation("TrainerClients")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("users")
}

enum Role {
  TRAINER
  CLIENT
}

model ClientProfile {
  id          String    @id @default(uuid())
  userId      String    @unique @map("user_id")
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  workspaceId String    @map("workspace_id")
  workspace   Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)

  billingFrequency BillingFrequency @map("billing_frequency")
  sessionRate      Decimal          @map("session_rate") @db.Decimal(10, 2)
  groupSessionRate Decimal?         @map("group_session_rate") @db.Decimal(10, 2)
  notes            String?          @db.Text

  // Invoice Settings
  autoInvoiceEnabled Boolean @default(true) @map("auto_invoice_enabled") // Opt-out per client

  // Group Session Permissions
  groupSessionPermission   String  @default("NO_GROUP_SESSIONS") @map("group_session_permission") // NO_GROUP_SESSIONS, ALLOW_ALL_GROUP, ALLOW_SPECIFIC_CLIENTS
  groupSessionDiscoverable Boolean @default(false) @map("group_session_discoverable") // Opt-in to be visible in other clients' allowed lists

  // Notification Preferences
  smsNotificationsEnabled     Boolean @default(false) @map("sms_notifications_enabled")
  emailNotificationsEnabled   Boolean @default(true) @map("email_notifications_enabled")
  appointmentRemindersEnabled Boolean @default(true) @map("appointment_reminders_enabled")
  invoiceAlertsEnabled        Boolean @default(true) @map("invoice_alerts_enabled")

  // Relations for allowed clients (specific permissions)
  allowedGroupClients GroupSessionAllowedClient[] @relation("AllowerProfile")
  allowedByClients    GroupSessionAllowedClient[] @relation("AllowedProfile")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("client_profiles")
}

enum BillingFrequency {
  PER_SESSION
  MONTHLY
}

model ClientTrainer {
  id          String    @id @default(uuid())
  clientId    String    @map("client_id")
  client      User      @relation("ClientTrainers", fields: [clientId], references: [id], onDelete: Cascade)
  trainerId   String    @map("trainer_id")
  trainer     User      @relation("TrainerClients", fields: [trainerId], references: [id], onDelete: Cascade)
  workspaceId String    @map("workspace_id")
  workspace   Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)

  isActive  Boolean   @default(true) @map("is_active")
  startDate DateTime  @default(now()) @map("start_date")
  endDate   DateTime? @map("end_date")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@unique([clientId, trainerId, workspaceId])
  @@index([clientId])
  @@index([trainerId])
  @@index([workspaceId])
  @@map("client_trainers")
}

model GroupSessionAllowedClient {
  id               String        @id @default(uuid())
  allowerProfileId String        @map("allower_profile_id")
  allowerProfile   ClientProfile @relation("AllowerProfile", fields: [allowerProfileId], references: [id], onDelete: Cascade)
  allowedProfileId String        @map("allowed_profile_id")
  allowedProfile   ClientProfile @relation("AllowedProfile", fields: [allowedProfileId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now()) @map("created_at")

  @@unique([allowerProfileId, allowedProfileId])
  @@index([allowerProfileId])
  @@index([allowedProfileId])
  @@map("group_session_allowed_clients")
}

// ============================================================================
// Scheduling Models
// ============================================================================

model AvailabilityBlock {
  id          String    @id @default(uuid())
  workspaceId String    @map("workspace_id")
  workspace   Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  trainerId   String    @map("trainer_id")
  trainer     User      @relation(fields: [trainerId], references: [id], onDelete: Cascade)

  dayOfWeek   Int     @map("day_of_week") // 0-6 (Sunday-Saturday)
  startTime   String  @map("start_time") // "09:00" format
  endTime     String  @map("end_time") // "17:00" format
  isRecurring Boolean @default(true) @map("is_recurring")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("availability_blocks")
}

model BlockedTime {
  id          String    @id @default(uuid())
  workspaceId String    @map("workspace_id")
  workspace   Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  trainerId   String    @map("trainer_id")
  trainer     User      @relation("TrainerBlockedTimes", fields: [trainerId], references: [id], onDelete: Cascade)

  startTime   DateTime @map("start_time") // Specific date and time
  endTime     DateTime @map("end_time")
  reason      String?  @db.Text // Optional reason (vacation, appointment, etc.)
  isRecurring Boolean  @default(false) @map("is_recurring")
  dayOfWeek   Int?     @map("day_of_week") // For recurring blocks (0-6)

  calendarEventMappings CalendarEventMapping[]

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([workspaceId, trainerId])
  @@map("blocked_times")
}

model TrainerSettings {
  id          String    @id @default(uuid())
  workspaceId String    @map("workspace_id")
  workspace   Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  trainerId   String    @unique @map("trainer_id")
  trainer     User      @relation("TrainerSettings", fields: [trainerId], references: [id], onDelete: Cascade)

  dayStartTime String @default("06:00") @map("day_start_time") // "06:00" format
  dayEndTime   String @default("22:00") @map("day_end_time") // "22:00" format
  timezone     String @default("America/New_York") // IANA timezone

  // Google Calendar Integration
  googleCalendarConnected Boolean   @default(false) @map("google_calendar_connected")
  googleCalendarEmail     String?   @map("google_calendar_email")
  googleAccessToken       String?   @map("google_access_token") @db.Text // Encrypted
  googleRefreshToken      String?   @map("google_refresh_token") @db.Text // Encrypted
  googleCalendarId        String?   @map("google_calendar_id") // Primary calendar ID
  autoSyncEnabled         Boolean   @default(false) @map("auto_sync_enabled")
  lastSyncedAt            DateTime? @map("last_synced_at")
  syncDirection           String    @default("bidirectional") @map("sync_direction") // "push_only", "pull_only", "bidirectional"

  // Invoice Configuration
  autoInvoicingEnabled  Boolean @default(true) @map("auto_invoicing_enabled")
  monthlyInvoiceDay     Int     @default(1) @map("monthly_invoice_day") // 1-31
  defaultInvoiceDueDays Int     @default(30) @map("default_invoice_due_days") // Net 7, 15, 30, etc.

  // Pricing Configuration
  defaultIndividualSessionRate Decimal? @map("default_individual_session_rate") @db.Decimal(10, 2)
  defaultGroupSessionRate      Decimal? @map("default_group_session_rate") @db.Decimal(10, 2)

  // Group Session Configuration
  groupSessionMatchingLogic String @default("EXACT_MATCH") @map("group_session_matching_logic") // EXACT_MATCH, START_MATCH, END_MATCH, ANY_OVERLAP

  // Client Auto-Sync Settings
  autoClientSyncEnabled         Boolean   @default(false) @map("auto_client_sync_enabled")
  clientSyncLookbackDays        Int       @default(30) @map("client_sync_lookback_days")
  lastClientSyncAt              DateTime? @map("last_client_sync_at")
  hasCompletedInitialClientSync Boolean   @default(false) @map("has_completed_initial_client_sync")

  // Notification Settings - Appointment Reminders
  appointmentReminderEnabled Boolean @default(true) @map("appointment_reminder_enabled")
  appointmentReminderHours   Json    @default("[24]") @map("appointment_reminder_hours") // Array of hours before appointment

  // Notification Settings - Invoice Reminders
  invoiceReminderBeforeDue     Boolean @default(true) @map("invoice_reminder_before_due")
  invoiceReminderBeforeDueDays Int     @default(3) @map("invoice_reminder_before_due_days")
  invoiceReminderOnDue         Boolean @default(true) @map("invoice_reminder_on_due")
  invoiceReminderOverdue       Boolean @default(true) @map("invoice_reminder_overdue")
  invoiceReminderOverdueDays   Json    @default("[3, 7]") @map("invoice_reminder_overdue_days") // Days after due date

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("trainer_settings")
}

model Appointment {
  id          String    @id @default(uuid())
  workspaceId String    @map("workspace_id")
  workspace   Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  trainerId   String    @map("trainer_id")
  trainer     User      @relation("TrainerAppointments", fields: [trainerId], references: [id], onDelete: Cascade)
  clientId    String    @map("client_id")
  client      User      @relation("ClientAppointments", fields: [clientId], references: [id], onDelete: Cascade)

  startTime          DateTime          @map("start_time")
  endTime            DateTime          @map("end_time")
  status             AppointmentStatus
  cancellationReason String?           @map("cancellation_reason") @db.Text

  // Group session override - NULL means use client's default permission
  // Values: "ALLOW_ALL", "ALLOW_SPECIFIC", "NO_GROUP"
  groupSessionOverride String? @map("group_session_override")

  workoutSession        WorkoutSession?
  invoiceLineItems      InvoiceLineItem[]
  calendarEventMappings CalendarEventMapping[]
  convertedFromPending  PendingAppointment?    @relation("ConvertedFromPending")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([workspaceId, startTime])
  @@index([trainerId, startTime])
  @@index([clientId, startTime])
  @@map("appointments")
}

enum AppointmentStatus {
  SCHEDULED
  COMPLETED
  CANCELLED
  RESCHEDULED
}

model PendingAppointment {
  id          String    @id @default(uuid())
  workspaceId String    @map("workspace_id")
  workspace   Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  trainerId   String    @map("trainer_id")
  trainer     User      @relation("TrainerPendingAppointments", fields: [trainerId], references: [id], onDelete: Cascade)

  // Event details from Google Calendar
  externalEventId    String   @map("external_event_id")
  externalEventTitle String   @map("external_event_title")
  startTime          DateTime @map("start_time")
  endTime            DateTime @map("end_time")

  // Smart detection
  suggestedClientId String? @map("suggested_client_id")
  suggestedClient   User?   @relation("ClientPendingAppointments", fields: [suggestedClientId], references: [id], onDelete: SetNull)
  matchConfidence   String  @map("match_confidence") // "high", "medium", "low"
  matchReason       String? @map("match_reason") @db.Text // Explanation of why this client was suggested

  // Status
  status String @default("pending") // "pending", "approved", "rejected", "converted"

  // If approved and converted
  createdAppointmentId String?      @unique @map("created_appointment_id")
  createdAppointment   Appointment? @relation("ConvertedFromPending", fields: [createdAppointmentId], references: [id], onDelete: SetNull)

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([workspaceId, trainerId, status])
  @@map("pending_appointments")
}

// ============================================================================
// Workout Tracking Models
// ============================================================================

model CustomMetricDefinition {
  id          String    @id @default(uuid())
  workspaceId String    @map("workspace_id")
  workspace   Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)

  name     String
  unit     String?
  dataType MetricDataType @map("data_type")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("custom_metric_definitions")
}

enum MetricDataType {
  NUMBER
  TEXT
  BOOLEAN
}

model WorkoutSession {
  id            String      @id @default(uuid())
  workspaceId   String      @map("workspace_id")
  workspace     Workspace   @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  appointmentId String      @unique @map("appointment_id")
  appointment   Appointment @relation(fields: [appointmentId], references: [id], onDelete: Cascade)

  trainerId String @map("trainer_id")
  trainer   User   @relation("TrainerSessions", fields: [trainerId], references: [id], onDelete: Cascade)
  clientId  String @map("client_id")
  client    User   @relation("ClientSessions", fields: [clientId], references: [id], onDelete: Cascade)

  date          DateTime @db.Date
  notes         String?  @db.Text
  exercises     Json? // Array of {name, sets, reps, weight, notes}
  customMetrics Json?    @map("custom_metrics") // {metric_name: value}

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([workspaceId, clientId, date])
  @@map("workout_sessions")
}

// ============================================================================
// Billing & Invoicing Models
// ============================================================================

model Invoice {
  id          String    @id @default(uuid())
  workspaceId String    @map("workspace_id")
  workspace   Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  trainerId   String    @map("trainer_id")
  trainer     User      @relation("TrainerInvoices", fields: [trainerId], references: [id], onDelete: Cascade)
  clientId    String    @map("client_id")
  client      User      @relation("ClientInvoices", fields: [clientId], references: [id], onDelete: Cascade)

  amount        Decimal        @db.Decimal(10, 2)
  dueDate       DateTime       @map("due_date") @db.Date
  paidAt        DateTime?      @map("paid_at")
  status        InvoiceStatus
  paymentMethod PaymentMethod? @map("payment_method")
  notes         String?        @db.Text

  lineItems InvoiceLineItem[]

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([workspaceId, status])
  @@index([clientId, dueDate])
  @@map("invoices")
}

enum InvoiceStatus {
  DRAFT
  SENT
  PAID
  OVERDUE
  CANCELLED
}

enum PaymentMethod {
  CASH
  VENMO
  ZELLE
  CHECK
  OTHER
}

model InvoiceLineItem {
  id            String       @id @default(uuid())
  invoiceId     String       @map("invoice_id")
  invoice       Invoice      @relation(fields: [invoiceId], references: [id], onDelete: Cascade)
  appointmentId String?      @map("appointment_id")
  appointment   Appointment? @relation(fields: [appointmentId], references: [id], onDelete: SetNull)

  description String
  quantity    Int
  unitPrice   Decimal @map("unit_price") @db.Decimal(10, 2)
  total       Decimal @db.Decimal(10, 2)

  createdAt DateTime @default(now()) @map("created_at")

  @@map("invoice_line_items")
}

// ============================================================================
// Calendar Integration Models
// ============================================================================

model CalendarEventMapping {
  id          String    @id @default(uuid())
  workspaceId String    @map("workspace_id")
  workspace   Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)

  // Train app reference (one of these will be set)
  appointmentId String?      @map("appointment_id")
  appointment   Appointment? @relation(fields: [appointmentId], references: [id], onDelete: Cascade)
  blockedTimeId String?      @map("blocked_time_id")
  blockedTime   BlockedTime? @relation(fields: [blockedTimeId], references: [id], onDelete: Cascade)

  // External calendar reference
  provider           String @map("provider") // "google", future: "microsoft"
  externalEventId    String @map("external_event_id") // Google Calendar event ID
  externalCalendarId String @map("external_calendar_id") // Which calendar it's in

  // Sync metadata
  syncDirection String   @map("sync_direction") // "outbound" (train→google) or "inbound" (google→train)
  lastSyncedAt  DateTime @default(now()) @map("last_synced_at")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@unique([provider, externalEventId])
  @@index([appointmentId])
  @@index([blockedTimeId])
  @@index([workspaceId])
  @@map("calendar_event_mappings")
}

model PendingClientProfile {
  id          String    @id @default(uuid())
  workspaceId String    @map("workspace_id")
  workspace   Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  trainerId   String    @map("trainer_id")
  trainer     User      @relation("TrainerPendingClientProfiles", fields: [trainerId], references: [id], onDelete: Cascade)

  // Source tracking
  source         String   @map("source") // "google", "microsoft", "apple"
  sourceEventIds String[] @map("source_event_ids") @db.Text

  // Extracted data
  extractedName  String  @map("extracted_name")
  extractedEmail String? @map("extracted_email")
  extractedPhone String? @map("extracted_phone")

  // Detection metadata
  extractionConfidence String   @map("extraction_confidence") // "high", "medium", "low"
  extractionReason     String   @map("extraction_reason") @db.Text
  firstSeenDate        DateTime @map("first_seen_date")
  occurrenceCount      Int      @default(1) @map("occurrence_count")

  // Review status
  status String @default("pending") // "pending", "approved", "rejected", "duplicate"

  // Editable fields (trainer reviews before approval)
  reviewedName  String? @map("reviewed_name")
  reviewedEmail String? @map("reviewed_email")
  reviewedPhone String? @map("reviewed_phone")
  reviewedNotes String? @map("reviewed_notes") @db.Text

  // Default billing (editable)
  defaultBillingFrequency String  @default("PER_SESSION") @map("default_billing_frequency")
  defaultSessionRate      Decimal @default(0) @map("default_session_rate") @db.Decimal(10, 2)

  // Created client link
  createdClientId String? @unique @map("created_client_id")
  createdClient   User?   @relation("ConvertedFromPendingClient", fields: [createdClientId], references: [id], onDelete: SetNull)

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([workspaceId, trainerId, status])
  @@index([source, extractedName])
  @@map("pending_client_profiles")
}

// ============================================================================
// Notification Models
// ============================================================================

model NotificationLog {
  id          String    @id @default(uuid())
  workspaceId String    @map("workspace_id")
  workspace   Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)

  // Recipient
  recipientId   String @map("recipient_id")
  recipientType String @map("recipient_type") // "CLIENT" or "TRAINER"

  // Notification Details
  channel String // "SMS" or "EMAIL"
  type    String // "APPOINTMENT_REMINDER", "INVOICE_SENT", "INVOICE_DUE_SOON", "INVOICE_OVERDUE"

  // Reference IDs (nullable based on type)
  appointmentId String? @map("appointment_id")
  invoiceId     String? @map("invoice_id")

  // Content
  phoneNumber    String? @map("phone_number")
  emailAddress   String? @map("email_address")
  messageContent String  @map("message_content") @db.Text

  // Delivery Status
  status       NotificationStatus @default(PENDING)
  externalId   String?            @map("external_id") // Twilio SID or SendGrid message ID
  errorMessage String?            @map("error_message") @db.Text

  // Retry tracking
  attemptCount  Int       @default(0) @map("attempt_count")
  lastAttemptAt DateTime? @map("last_attempt_at")
  nextRetryAt   DateTime? @map("next_retry_at")

  // Timestamps
  sentAt      DateTime? @map("sent_at")
  deliveredAt DateTime? @map("delivered_at")
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")

  @@index([workspaceId, recipientId])
  @@index([status, nextRetryAt])
  @@index([appointmentId])
  @@index([invoiceId])
  @@map("notification_logs")
}

enum NotificationStatus {
  PENDING
  SENT
  DELIVERED
  FAILED
}
